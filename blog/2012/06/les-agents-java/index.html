<!DOCTYPE html>
<html lang="en-us">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.53" />

    
    
    

<title>Les agents Java • Gildas Cuisinier</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Les agents Java"/>
<meta name="twitter:description" content="Les Agents Java ? Pas la moindre idée de ce que c&rsquo;est ?
Mais si, vous en avez certainement déja vu, ils se cachent dans la ligne de commande Java via ce paramètre -javaagent:vers/mon/agent.jar.

Ceux-ci interviennent lors du chargement des classes par un classloader, et ont la possiblité de venir modifier la classe en cours de chargement. Ce mécanisme est utilisé par divers outils et frameworks :


AspectJ pour faire du tissage d&rsquo;Aspect au chargement
Par des outils de Profiling pour venir ajouter du code permettant de tracer les appels
&hellip; et plein d&rsquo;autres
"/>

<meta property="og:title" content="Les agents Java" />
<meta property="og:description" content="Les Agents Java ? Pas la moindre idée de ce que c&rsquo;est ?
Mais si, vous en avez certainement déja vu, ils se cachent dans la ligne de commande Java via ce paramètre -javaagent:vers/mon/agent.jar.

Ceux-ci interviennent lors du chargement des classes par un classloader, et ont la possiblité de venir modifier la classe en cours de chargement. Ce mécanisme est utilisé par divers outils et frameworks :


AspectJ pour faire du tissage d&rsquo;Aspect au chargement
Par des outils de Profiling pour venir ajouter du code permettant de tracer les appels
&hellip; et plein d&rsquo;autres
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.gcuisinier.net/blog/2012/06/les-agents-java/" /><meta property="article:published_time" content="2012-06-15T08:00:00&#43;01:00"/>
<meta property="article:modified_time" content="2012-06-15T08:00:00&#43;01:00"/>


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">








<link rel="stylesheet" href="/scss/hyde-hyde.9b47255fe7feae0b7a7befc8c22902cc12b602757ee6a841471810f413cdcf33.css" integrity="sha256-m0clX&#43;f&#43;rgt6e&#43;/IwikCzBK2AnV&#43;5qhBRxgQ9BPNzzM=">


<link rel="stylesheet" href="/scss/print.5aa4005c7565ec5b66c62cd79012c5cad1081f3332793145a8d3861a26391697.css" integrity="sha256-WqQAXHVl7FtmxizXkBLFytEIHzMyeTFFqNOGGiY5Fpc=" media="print">



    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

</head>


    <body class=" ">
    
<div class="sidebar">
  <div class="container  vertical-center">
    <div class="sidebar-about">
      <span class="site__title">
        <a href="https://www.gcuisinier.net">Gildas Cuisinier</a>
      </span>
      <small class="text-center center-block">&lt;dev&gt;SomeWhere&lt;ops&gt;</small>
      
      
        
        
        
        <div class="author-image">
          <img src="https://www.gcuisinier.net/img/gcuisinier.jpg" alt="Author Image" class="img--circle img--headshot element--center">
        </div>
        
      
      
      <p class="site__description">
        
      </p>
    </div>
    <div class="collapsible-menu">
      <input type="checkbox" id="menuToggle">
      <label for="menuToggle">Gildas Cuisinier</label>
      <div class="menu-content">
        <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/posts/">
						<span>Blog</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/portfolio/">
						<span>Projects</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

        <section class="social">
	
	<a href="https://twitter.com/gcuisinier" rel="me"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/gcuisinier" rel="me"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	
	<a href="https://keybase.io/gcuisinier" rel="me"><i class="fab fa-keybase fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://about.me/gcuisinier"><i class="fas fa-address-card fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://hub.docker.com/u/gcuisinier"><i class="fab fa-docker fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	<a href="mailto:contact%20[at]%20gcuisinier.net" rel="me"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a>
	
</section>

      </div>
    </div>
    

<div class="builtwith">
Built with <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
</div>


  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Les agents Java</h1>
    
    
<div class="post__meta">
    
    
      <i class="fas fa-calendar-alt"></i> Jun 15, 2012
    
    
    
    
    
      
      
          <br/>
           <i class="fas fa-tags"></i>
          
          <a class="badge badge-tag" href="/tags/french">french</a>
           
      
          <a class="badge badge-tag" href="/tags/java">java</a>
          
      
    
    
    <br/>
    <i class="fas fa-clock"></i> 5 min read
</div>


  </header>
  
  
  <div class="post">
    <p>Les Agents Java ? Pas la moindre idée de ce que c&rsquo;est ?
Mais si, vous en avez certainement déja vu, ils se cachent dans la ligne de commande Java via ce paramètre <code>-javaagent:vers/mon/agent.jar</code>.</p>

<p>Ceux-ci interviennent lors du chargement des classes par un classloader, et ont la possiblité de venir modifier la classe en cours de chargement. Ce mécanisme est utilisé par divers outils et frameworks :</p>

<ul>
<li>AspectJ pour faire du tissage d&rsquo;Aspect au chargement</li>
<li>Par des outils de Profiling pour venir ajouter du code permettant de tracer les appels</li>
<li>&hellip; et plein d&rsquo;autres</li>
</ul>

<h2 id="getting-started">Getting started !</h2>

<p>Pour mieux comprendre comment fonctionne un agent, le plus simple est de tenter d&rsquo;en faire un simple.</p>

<h3 id="créer-la-classe-de-l-agent">Créer la classe de l&rsquo;agent</h3>

<pre><code class="language-java">package be.hikage.agent;

import java.lang.instrument.Instrumentation;

public class AgentSimple {

	public static void premain(String agentArgument, Instrumentation instrumentation){		
		System.out.println(&quot;Hello, Agent Smith ! [ &quot; + agentArgument + &quot;]&quot;);
	}
}
</code></pre>

<p>La méthode <code>premain(String agentArgument, Instrumentation instrumentation)</code> est pour un agent ce qu&rsquo;est la méthode <code>main(String &hellip; arguments)</code> est pour une application Java.</p>

<p>Cette méthode appelée lors du chargement de l&rsquo;agent, et possède deux arguments :</p>

<ul>
<li><code>String agentArguments</code> : Ce sont les options passée en paramètre dans la ligne de commande pour l&rsquo;agent. <code>-javaagent:jarpath=parametre</code></li>
<li><code>Instrumentation instrumentation</code>, est un service qui va fournir des méthodes pour modifier les classes.</li>
</ul>

<h3 id="préparer-le-packaging">Préparer le packaging</h3>

<p>Mais avoir la classe ne suffit pas pour avoir un agent utilisable. En effet, un agent doit obligatoirement un jar, avec un manifest correctement configuré.</p>

<p>Celui-ci doit contenir une entrée <code>Premain-Class</code></p>

<pre><code>Manifest-Version: 1.0
Premain-Class: be.hikage.agent.AgentSimple
</code></pre>

<h3 id="tester-l-agent">Tester l&rsquo;Agent</h3>

<p>Une fois le <strong>Jar</strong> prêt, il faut le tester. Pour cela créer un petit programme simple :</p>

<pre><code class="language-java">public class TestMain {

	public static void main(String[] args) {
		System.out.println(&quot;Mon Programme&quot;);
	}
}
</code></pre>

<p>Et lançons celui-ci en fournissant l&rsquo;agent :</p>

<pre><code class="language-sh">$ java -javaagent:AgentSimple.jar=&quot;Mes paramètres&quot; be.hikage.agent.TestMain
Hello, Agent Smith ! [ Mes paramètres]
Mon Programme
</code></pre>

<p>On remarque que l&rsquo;agent est bien lancé avant l&rsquo;application, et qu&rsquo;il a bien reçu les paramètres que l&rsquo;on lui a fourni.</p>

<h2 id="interception-des-chargements-de-classes">Interception des chargements de classes</h2>

<p>Voyons maintenant à quoi sert le deuxième paramètre fourni à la méthode <em>Premain</em> : Instrumentation.
La principale fonctionnalité de celui-ci est de permettre d&rsquo;enregistrer un <em>ClassFileTransformer</em>. Cette interface oblige à implémenter une unique méthode :</p>

<pre><code class="language-java">byte[]
    transform(  ClassLoader         loader,
                String              className,
                Class            classBeingRedefined,
                ProtectionDomain    protectionDomain,
                byte[]              classfileBuffer)
        throws IllegalClassFormatException;
</code></pre>

<p>Le premier paramètre étant le classloader impliqué pour le chargement de la classe. Les deux suivant, le nom de la classe et l&rsquo;instance de Class représentant la classe en train d&rsquo;être chargée.
Le dernier est le bytecode brut de la classe, sous la forme d&rsquo;un tableau de bytes.</p>

<p>Modifions maintenant notre agent pour afficher les classes en cours de chargement :</p>

<pre><code class="language-java">package be.hikage.agent;

import java.lang.instrument.ClassFileTransformer;
import java.lang.instrument.IllegalClassFormatException;
import java.lang.instrument.Instrumentation;
import java.security.ProtectionDomain;

public class AgentSimple {

	public static void premain(String agentArgument, Instrumentation instrumentation){		
		System.out.println(&quot;Hello, Agent Smith ! [ &quot; + agentArgument + &quot;]&quot;);

        instrumentation.addTransformer( new ClassFileTransformer() {
            @Override
            public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
                System.out.println(&quot;Tu es en train de charger la classe :&quot; + className);
                return classfileBuffer;
            }
        });
	}
}
</code></pre>

<p>Le résultat sera le suivant :</p>

<pre><code>Hello, Agent Smith ! [ Mes paramètres]
Tu es en train de charger la classe : sun/launcher/LauncherHelper
Tu es en train de charger la classe : java/lang/Enum
Tu es en train de charger la classe : be/hikage/agent/TestMain
Tu es en train de charger la classe : java/lang/Void
Mon Programme
Tu es en train de charger la classe : java/lang/Shutdown
Tu es en train de charger la classe : java/lang/Shutdown$Lock
</code></pre>

<h2 id="modification-de-classe">Modification de classe</h2>

<p>Passons maintenant la seconde, et tentons de venir modifier les classes en cours de chargement afin d&rsquo;avoir des statistiques sur le nombre d&rsquo;instance.
Pour cela, il suffit d&rsquo;ajouter un champ statique qui servira de compteur, et de modifier les constructeurs pour y ajouter une incrémentation de celui-ci ainsi que de l&rsquo;afficher dans les logs.</p>

<p>Pour cela, il faut utiliser un outil de manipulation de bytecode tels que <a href="http://www.jboss.org/javassist">Javassist</a>.
Voici une implémentation d&rsquo;un ClassFileTransformer possible :</p>

<pre><code class="language-java">package be.hikage.agent;

import javassist.ClassPool;
import javassist.CtBehavior;
import javassist.CtClass;
import javassist.CtField;

import java.lang.instrument.ClassFileTransformer;
import java.lang.instrument.IllegalClassFormatException;
import java.security.ProtectionDomain;

public class CountInstanceTransformer implements ClassFileTransformer {


    @Override
    public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException {
        return visitClass(className, classBeingRedefined, classfileBuffer);

    }

    private byte[] visitClass(String className, Class&lt;?&gt; classBeingRedefined, byte[] classfileBuffer) {
        ClassPool pool = ClassPool.getDefault();
        CtClass cl = null;
        try {
            cl = pool.makeClass(new java.io.ByteArrayInputStream(classfileBuffer));
            if (cl.isInterface() == false) {

                // Ajout d'un champ static dans la classe
                CtField field = CtField.make(&quot;private static long _instanceCount;&quot;, cl);

                cl.addField(field);

                CtBehavior[] constructors = cl.getDeclaredConstructors();
                for (int i = 0; i &lt; constructors.length; i++) {
                    // On incrémente le compteur et on l'affiche
                    constructors[i].insertAfter(&quot;_instanceCount++;&quot;);
                    constructors[i].insertAfter(&quot;System.out.println(\&quot;&quot; + className + &quot; : \&quot; + _instanceCount);&quot;);


                }

                // Génération du bytecode modifié
                classfileBuffer = cl.toBytecode();
            }
        } catch (Exception e) {
            e.printStackTrace();

        } finally {
            if (cl != null) {
                cl.detach();
            }
        }
        return classfileBuffer;
    }
}
</code></pre>

<p>Et un petit programme de tests :</p>

<pre><code class="language-java">public class TestMain {

	public static void main(String[] args) {
		System.out.println(&quot;Mon Programme&quot;);
        List test = new ArrayList();
        test.add(new MonObject()) ;
        test.add(new MonObject()) ;
        test.add(new MonObject()) ;
        test.add(new MonObject()) ;
	}
}
</code></pre>

<p>Le lancement de l&rsquo;agent se fait de la même manière qu&rsquo;auparavant. Cependant, celui-ci apporte une dépendance supplémentaire, Javassist, au runtime.
Il faut donc que celui-ci soit disponible dans le classpath :</p>

<pre><code>$ java -classpath &quot;path/to/javassist-3.14.0-GA.jar:./&quot; -javaagent:AgentSimple.jar=&quot;Mes paramètres&quot; be.hikage.agent.TestMain
Hello, Agent Smith ! [ Mes paramètres]
java/lang/Enum : 1
sun/launcher/LauncherHelper : 1
Mon Programme
be/hikage/agent/MonObject : 1
be/hikage/agent/MonObject : 2
be/hikage/agent/MonObject : 3
be/hikage/agent/MonObject : 4
java/lang/Shutdown$Lock : 1
java/lang/Shutdown$Lock : 2
java/lang/Shutdown$Lock : 3
java/lang/Shutdown$Lock : 4
</code></pre>

<h1 id="conclusion">Conclusion</h1>

<p>Les Agents Java sont assez simple à mettre en place, et les possibilités sont assez nombreuses.
Cependant, cela nécessite d&rsquo;avoir déclarer celui-ci au démarrage de l&rsquo;application.</p>

<p>Et parfois, on aimerait avoir la possibilité d&rsquo;activer un agent plus tard, au besoin.
Pour cela, il existe une API, l&rsquo;Attach API.
Celle-ci fera l&rsquo;objet d&rsquo;un prochain article.</p>
  </div>
  

<div class="navigation navigation-single">
    
    <a href="/blog/2012/04/mon-retour-sur-devoxx-france-en-tant-que-conf%C3%A9rencier/" class="navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Mon retour sur Devoxx France, en tant que conférencier</span>
    </a>
    
    
</div>


  

  
    


</article>


        </div>
        
    
<script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
        
    
    <script type="text/javascript">
        
        hljs.initHighlightingOnLoad();
    </script>
    




    



    </body>
</html>
